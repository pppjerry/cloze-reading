name: Build and Release Extension

on:
  push:
    tags:
      - 'v*'  # 匹配所有以 v 开头的 tag，如 v1.0.0, v0.1.0

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # 需要写入权限来创建 Release
      actions: read   # 读取权限（默认）
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Get tag name
        id: tag
        run: echo "name=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
      
      - name: Create extension package
        run: |
          # 创建临时打包目录
          mkdir -p dist/package
          cp -r src dist/package/
          cp manifest.json dist/package/
          cp README.md dist/package/
          
          # 确保打包版本的 manifest.json 使用正式版本号（移除 -dev, -test 等后缀）
          # 从 tag 中提取版本号（去掉 v 前缀）
          VERSION="${{ steps.tag.outputs.name }}"
          VERSION=${VERSION#v}  # 移除 v 前缀
          VERSION=${VERSION%%-*}  # 移除 -dev, -test 等后缀
          
          # 更新 manifest.json 中的版本号
          cd dist/package
          if command -v jq &> /dev/null; then
            # 如果有 jq，使用 jq 更新版本号
            jq ".version = \"$VERSION\"" manifest.json > manifest.json.tmp && mv manifest.json.tmp manifest.json
          else
            # 如果没有 jq，使用 sed 更新版本号
            sed -i.bak "s/\"version\": \".*\"/\"version\": \"$VERSION\"/" manifest.json
            rm -f manifest.json.bak
          fi
          
          # 创建 zip 文件
          zip -r "../cloze-reading-${{ steps.tag.outputs.name }}.zip" . \
            -x "*.DS_Store" \
            -x "*/.git/*"
          
          # 返回根目录
          cd ../..
          
          # 验证 zip 文件
          ls -lh dist/cloze-reading-${{ steps.tag.outputs.name }}.zip
      
      - name: Upload release artifact
        uses: actions/upload-artifact@v4
        with:
          name: cloze-reading-${{ steps.tag.outputs.name }}
          path: dist/cloze-reading-${{ steps.tag.outputs.name }}.zip
          retention-days: 30
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: dist/cloze-reading-${{ steps.tag.outputs.name }}.zip
          tag_name: ${{ steps.tag.outputs.name }}
          name: Release ${{ steps.tag.outputs.name }}
          body: |
            ## Cloze Reading Extension ${{ steps.tag.outputs.name }}
            
            ### 安装说明
            
            1. 下载 `cloze-reading-${{ steps.tag.outputs.name }}.zip` 文件
            2. 解压 zip 文件
            3. 在浏览器中打开扩展管理页面（Chrome: `chrome://extensions/`，Edge: `edge://extensions/`）
            4. 开启"开发者模式"
            5. 点击"加载已解压的扩展程序"，选择解压后的文件夹
            
            ### 功能说明
            
            查看 [README.md](README.md) 了解详细功能和使用说明。
          draft: false
          prerelease: false
          generate_release_notes: false

