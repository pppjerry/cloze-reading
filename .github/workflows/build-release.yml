name: Build and Release Extension

on:
  push:
    tags:
      - 'v*'  # 匹配所有以 v 开头的 tag，如 v1.0.0, v0.1.0

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # 需要写入权限来创建 Release
      actions: read   # 读取权限（默认）
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Get tag name
        id: tag
        run: echo "name=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
      
      - name: Create extension package
        run: |
          # 创建临时打包目录
          mkdir -p dist/package
          
          # 确定插件目录（如果 workflow 在 cloze-reading/.github 下，则当前目录就是插件目录）
          # 如果 workflow 在仓库根目录，则需要进入 cloze-reading 目录
          if [ -d "cloze-reading/src" ]; then
            # 在仓库根目录，插件在 cloze-reading 子目录
            cp -r cloze-reading/src dist/package/
            cp cloze-reading/manifest.json dist/package/
            cp cloze-reading/README.md dist/package/
          elif [ -d "src" ]; then
            # 已经在插件目录
            cp -r src dist/package/
            cp manifest.json dist/package/
            cp README.md dist/package/
          else
            echo "Error: Cannot find plugin files"
            ls -la
            exit 1
          fi
          
          # 进入打包目录创建 zip
          cd dist/package
          zip -r "../cloze-reading-${{ steps.tag.outputs.name }}.zip" . \
            -x "*.DS_Store" \
            -x "*/.git/*"
          
          # 返回根目录
          cd ../..
          
          # 验证 zip 文件
          ls -lh dist/cloze-reading-${{ steps.tag.outputs.name }}.zip
      
      - name: Upload release artifact
        uses: actions/upload-artifact@v4
        with:
          name: cloze-reading-${{ steps.tag.outputs.name }}
          path: dist/cloze-reading-${{ steps.tag.outputs.name }}.zip
          retention-days: 30
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: dist/cloze-reading-${{ steps.tag.outputs.name }}.zip
          tag_name: ${{ steps.tag.outputs.name }}
          name: Release ${{ steps.tag.outputs.name }}
          body: |
            ## Cloze Reading Extension ${{ steps.tag.outputs.name }}
            
            ### 安装说明
            
            1. 下载 `cloze-reading-${{ steps.tag.outputs.name }}.zip` 文件
            2. 解压 zip 文件
            3. 在浏览器中打开扩展管理页面（Chrome: `chrome://extensions/`，Edge: `edge://extensions/`）
            4. 开启"开发者模式"
            5. 点击"加载已解压的扩展程序"，选择解压后的文件夹
            
            ### 变更日志
            
            查看 [README.md](README.md) 了解详细功能和使用说明。
          draft: false
          prerelease: false
          generate_release_notes: false

